name: Detection 02
description: | 
  Find Service Principals (SPs) that are members of a directory role. The SPs must be
  of type ‘Application’, be enabled, and have at least one credential (password or key)
  configured to support client credential flow.

query: |
  SELECT DISTINCT sp.id AS sp_id
  FROM sp_member_of smo
  JOIN service_principals sp
    ON sp.id = smo.service_principal_id
    WHERE smo."@odata.type" = '#microsoft.graph.directoryRole'
      AND sp.servicePrincipalType = 'Application'
      AND sp.accountEnabled = 1
      AND (
        json_array_length(sp.passwordCredentials) > 0
        OR json_array_length(sp.keyCredentials) > 0
      );
  
output:
  - type: table
    title: "Directory Role Assigned to Service Principal and Client Credential Configured"
    columns:
      - 
        - data_view: "service_principal"
        - data_view: "service_principal.member_of[]"
        - data_view: "service_principal.passwordCredentials[]"
        - data_view: "service_principal.keyCredentials[]"
      - 
        - data_view: "service_principal.application"
        - data_view: "service_principal.application.passwordCredentials[]"
        - data_view: "service_principal.application.keyCredentials[]"

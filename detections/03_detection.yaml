name: Detection 03
description: | 
  Find third-party applications not hosted in the home tenant. Microsoft-owned applications
  (first-party) are excluded from the results. Only applications that have been assigned
  permissions to resources or are members of directory roles are included. If an attacker
  compromises a client credential belonging to one of these third-party applications in an
  external tenant, they could authenticate as the application and assume its permissions. 

query: |
 SELECT sp.id
  FROM service_principals sp
  LEFT JOIN applications app ON sp.appId = app.appId
  WHERE app.appId IS NULL
    AND sp.servicePrincipalType = 'Application'
    AND sp.accountEnabled = 1
    AND sp.appOwnerOrganizationId NOT IN (
        'f8cdef31-a31e-4b4a-93e4-5f571e91255a',
        '72f988bf-86f1-41af-91ab-2d7cd011db47'
    )
    AND (
      EXISTS (
        SELECT 1
        FROM app_role_assigned_to arat
        WHERE arat.principalId = sp.id
      )
      OR EXISTS (
        SELECT 1
        FROM sp_member_of smo
        WHERE smo.service_principal_id = sp.id
          AND smo."@odata.type" = '#microsoft.graph.directoryRole'
      )
    )

output:
  - type: table
    title: "3rd Party App Running in Tenant (excluding Microsoft)"
    columns:
      - 
        - data_view: "service_principal"
        -
      - 
        - data_view: "service_principal.appRoleImports[]"
        - data_view: "service_principal.member_of[]"
